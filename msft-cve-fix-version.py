#!/usr/bin/env python

import sys
import requests
import json


def urldata(url):
    response = requests.get(url, headers={"accept": "application/json"})
    if response.status_code != 200:
        print('{} status code for URL: {}'.format(response.status_code, url))
        print(response.content)
        sys.exit(1)
    return response.content


if __name__ == "__main__":
    cves = list(set(sys.argv[1:]))
    baseurl = "https://api.msrc.microsoft.com/cvrf/v2.0/"

    # to get CVE data, need to find the "Cvrf" that contains it from
    # the "Updates" endpoint
    # https://api.msrc.microsoft.com/cvrf/v2.0/swagger/index
    update_feeds = [baseurl + f"Updates('{cve}')" for cve in cves]
    update_jsons = [json.loads(urldata(feed)) for feed in update_feeds]
    cvrfs = list(set([j['value'][0]['CvrfUrl'] for j in update_jsons]))
    cve_jsons = [json.loads(urldata(cvrf))['Vulnerability'] for cvrf in cvrfs]
    our_cves = [list(filter(lambda x: x['CVE'] in cves, data)) for data in cve_jsons]

    # flatten into a raw list rather than a list of CVE data lists
    our_cves = [y for x in our_cves for y in x]

    for cve in our_cves:
        # now output all the build numbers we're looking for
        print(f"{cve['CVE']}: " + " ".join(list(map(lambda x: x['FixedBuild'], cve['Remediations']))))
